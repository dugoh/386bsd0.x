################################################################################
## Find an upgrade path to 0.x. A quick look in the git repo shows a push of a
## running machine. Due to the limitations of source code control systems this
## will be very hard to boot directly. Booting the original and upgrading it
## looks like the way to go.

index() {
    echo "<HTML><HEAD><TITLE>LINKS</TITLE></HEAD><BODY><ul>" >index.html
    for file in $(ls|egrep -v "index.html| "); do \
        (\
            printf '<li><a href="'; \
            printf "${file}";       \
            printf '">';            \
            printf "${file}";       \
            printf '</a></li>\n'    \
        )>>index.html;              \
    done
    echo "</ul></BODY></HTML>" >>index.html
}

push() {
    GHP_URL=https://${GHP_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git
    git init
    git config user.name "${USER}"
    git config user.email "${GHP_MAIL}"
    git add .
    git commit -m "Deploy to GitHub Pages"
    git push --force --quiet "${GHP_URL}" master:gh-pages
}

## init
set -x
cd /
mkdir /gh-pages

## Grab a clean 0.1 install and mount it.

for i in a b c;
    do wget -nv -O - https://dugoh.github.io/386bsd0.1/disk.part-a${i};
done|bunzip2 >disk.img || exit 1

modprobe ufs
mount -o loop,ro -t ufs disk.img /mnt/

## Copy out the relevant directories.

mkdir /0.1
cd /mnt
cp -R -p etc /0.1/
cp -R -p usr /0.1/
cp -R -p var /0.1/

## Clone the 386bsd github repo and checkout 0.x.

cd /
git clone https://github.com/386bsd/386bsd.git
cd 386bsd
cat .gitignore
git checkout 0.1

## Copy out the relevant directories to diff

mkdir /0.x
cp -R -p etc /0.x/
cp -R -p usr /0.x/
cp -R -p var /0.x/

## Some more reorganisation to solve the high number of differences.

## There is no usr/othersrc in 0.x.

mv /0.1/usr/othersrc/[cegps]* /0.1/usr/src/
rm -rf /0.1/usr/othersrc/

## Clean out kernel build remnants

rm -rf /0.?/usr/src/sys.386bsd/compile/*

## There are no games in share in 0.x, only a book about chess.

find /0.1/usr/share/games/* -type d -exec rm -rf {} \;

## Check for any new symlinks.

cd /0.1 ; find ./ -type l|sort >/tmp/0.1-links
cd /0.x ; find ./ -type l|sort >/tmp/0.x-links
diff /tmp/0.1-links /tmp/0.x-links |tee /gh-pages/link-diffs.txt

## Remove the directory that will become a link.

rm -rf /0.1/usr/include/vm 

## Get rid of all symlinks to make life easy for diff.

find /0.?/ -type l -exec rm {} \;

## Apply 0.x .gitignore to 0.1.

find /0.1/ -type f -name "*.o" -exec rm -rf {} \;
find /0.1/ -type f -name "*.a" -exec rm -rf {} \;

## The diff should be reasonably sized now. Dump the interim differences.

#diff -qrN /0.1/etc /0.x/etc |tee /gh-pages/etc-i-diffs.txt
#diff -qrN /0.1/usr /0.x/usr |tee /gh-pages/usr-i-diffs.txt
#diff -qrN /0.1/var /0.x/var |tee /gh-pages/var-i-diffs.txt

#### Check /etc

## Some files got corrupt, get rid of them.

for file in $(find /0.x/etc -type f -size +0 -exec grep -zaPL [^\0] {} \;); do
    rm "${file}"
done

## The files differing in /etc/ are mostly local. Clean most of it out.

find /0.?/etc/ -type f ! -name disktab ! -name bin.profile -exec rm -rf {} \;

#### Check /usr

## A bit odd, the ufs dir forks in tree.

cp -r -p /0.1/usr/src/sys.386bsd/ufs /0.1/usr/src/

## Don't delete 0.1 binaries, don't pull in 0.x binaries.

rm $(file $(diff -qr /0.?/usr \
            |grep "^Only"     \
            |sed -e's/: /\//' \
            |cut -f 3         \
            )|grep "pure executable"|cut -d':' -f1)

#### Check /var

## There seems to be nothing to upgrade from there.

rm -rf /0.?/var/

## Dump the differences again.

echo etc
diff -qr /0.1/etc /0.x/etc |tee /gh-pages/etc-diffs.txt
echo usr
diff -qr /0.1/usr /0.x/usr |tee /gh-pages/usr-diffs.txt

## This is probably all that's needed to upgrade.
echo totar
diff -qr /0.x/ /0.1/ \
  |grep -v "^Only in /0.1/" \
  |sed -e's/: /\//' \
       -e's/Only in/OnlyIn/' \
  |awk '{print $2}'

## Tar it up to flop.

( tar cf - $( diff -qr /0.x/ /0.1/     \
              |grep -v "^Only in /0.1" \
              |sed -e's/: /\//'        \
                   -e's/.*0\.x\///'    \
                   -e's/ .*//'         \
            )
  dd if=/dev/zero count=1474560
) |head -c 1474560 >/boot.img

## Add an upgrade script.

cat >/0.x/upgrade.sh <<__EOF__
date 1903250331.34
cd /
mv /usr/othersrc/[cegps]* /usr/src/
rm -rf /0.1/usr/othersrc/
find /usr/share/games/* -type d -exec rm -rf {} \;
rm -rf /0.1/usr/include/vm 
ln -s ../src/sys.386bsd/vm /usr/include/vm
cp -R -p /usr/src/sys.386bsd/ufs /usr/src/
tar -xvf /dev/rfd0a
rm -r /sys/compile/*
cd /sys/i386/conf
config GENERICISA
cd /sys/compile/GENERICISA
make depend
make
mv /386bsd /386bsd.old
cp 386bsd /386bsd
sync; sync; sync
shutdown -rf now
__EOF__

cd /gh-pages
index
push
